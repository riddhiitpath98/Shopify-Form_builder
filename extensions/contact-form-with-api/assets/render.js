let rightIcon = `data:image/png;base64,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`;

// let formId;
let shopId;
let emailValidate;
const server = "https://shopifyappapi.project-demo.info:3008/api";
let formData = {};
let formCounter = 1;
let submitButtonCouter = 1;
let loaderCounter = 1;
let bannerCounter = 1;
let recaptcha_response = "";
const generateElementId = (type, id) => {
  let counter =
    type === "form"
      ? formCounter
      : type === "submit"
        ? submitButtonCouter
        : type === "loader"
          ? loaderCounter
          : type === "banner"
            ? bannerCounter
            : "";
  const uniqueElementId = `${id}-${counter}`;
  type === "form"
    ? formCounter++
    : type === "submit"
      ? submitButtonCouter++
      : type === "loader"
        ? loaderCounter++
        : type === "banner"
          ? bannerCounter++
          : "";
  return uniqueElementId;
};

const getValidation = async (id) => {
  const response = await fetch(`${server}/formsettings/validation/${id}`);
  const data = await response.json();
  return data.data.validation;
};
const getApperence = async (id) => {
  const response = await fetch(`${server}/formsettings/appearance/${id}`);
  const data = await response.json();
  return data.data.appearance;
};

const getAfterSubmit = async (id) => {
  const response = await fetch(`${server}/formsettings/afterSubmit/${id}`);
  const data = await response.json();
  return data.data.afterSubmit;
};

const getData = async (id) => {
  const response = await fetch(`${server}/custom_form/${id}`);
  const data = await response.json();
  return data.data;
};

const getUser = async (id) => {
  const response = await fetch(`${server}/user/${id}`);
  const data = await response.json();
  return data.data;
};

const handleRecaptcha = async () => {
  const response = await fetch(`${server}/setting/rechaptcha/${shopId}`);
  const data = await response.json();
  return data?.data;
};

const catchFormDivAndAppendForm = async (data) => {
  loadRecaptchaScript();
  loadFlatpickrScript();
  const enableRecaptcha = data?.elementData?.enableRecaptcha;
  let recaptchadata;
  if (enableRecaptcha) {
    recaptchadata = await handleRecaptcha();
  }

  const formElementId = generateElementId(
    "form",
    `myForm-${data?.elementData?._id}`
  );
  const submitButtonId = generateElementId(
    "submit",
    `submit-${data?.elementData?._id}`
  );
  const loaderElementId = generateElementId(
    "loader",
    `loader-${data?.elementData?._id}`
  );
  const bannerElementId = generateElementId(
    "banner",
    `polaris-banner-${data.elementData?._id}`
  );

  const checkElements = (plan, elem, checkPreview) => {
    const data = checkPreview
      ? elem.filter((val) => {
        if (!val?.viewAccess) return val;
        else if (val?.viewAccess?.includes(plan)) return val;
        else return null;
      })
      : elem.map((val) => {
        return {
          ...val,
          fields: val?.fields?.filter((item) => {
            if (!item?.viewAccess) {
              return item;
            } else if (item?.viewAccess?.includes(plan)) {
              return item;
            } else return null;
          }),
        };
      });
    return data;
  };

  const elements = (
    selectedPlan = SUBSCRIPTION_TYPES.FREE,
    inputFields = customElements,
    checkPreview
  ) => {
    if (!selectedPlan) return [];
    return checkElements(selectedPlan, inputFields, checkPreview);
  };


  let formFieldData = [];
  let formElement = [];
  let validation = {};
  let afterSubmit = {};
  const createSubmission = async (data, formId) => {
    const finalFormData = new FormData();
    finalFormData.append("shopId", shopId);
    if (data && Object.keys(data).length > 0) {
      for (const key in data) {
        if (data[key] !== "" && key.split("_").pop() === "file") {
          data[key]?.forEach((item) => {
            finalFormData.append(key, item);
          });
        } else if (Array.isArray(data[key]))
          finalFormData.append(key, JSON.stringify(data[key]));
        else {
          finalFormData.append(key, data[key]);
        }
      }
    }

    if (enableRecaptcha && recaptcha_response) {
      finalFormData.append("recaptcha_response", recaptcha_response);
    }
    try {
      const requestOptions = {
        method: "POST",
        body: finalFormData,
      };
      const response = await fetch(
        `${server}/submission/${formId}`,
        requestOptions
      );
      return response;
    } catch (error) {
      return error;
    }
  };

  const handleClose = (id) => {
    const banner = document.getElementById(`polaris-banner-${id}`);
    banner.style.display = "none";
  };

  const handleAppereance = (data = []) => {
    if (!data?.length) return {};
    const obj = {};
    const cloneData = [...data];
    cloneData.forEach((val) => {
      obj[val?.name] = val.value;
    });
    return obj;
  };

  const handleCaptchaChange = async (response) => {
    recaptcha_response = response;
    const captchaError = document.getElementById("captcha_error");
    captchaError.textContent = response === "" ? "please varify Captcha" : "";
  };

  function loadFlatpickrScript(callback) {
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href =
      "https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.css";
    document.head.appendChild(link);
    const script = document.createElement("script");
    script.src =
      "https://cdn.jsdelivr.net/npm/flatpickr@4.6.9/dist/flatpickr.min.js";
    script.onload = callback;
    document.head.appendChild(script);
  }

  function loadRecaptchaScript(callback) {
    const script = document.createElement("script");
    script.src = "https://www.google.com/recaptcha/api.js";
    script.async = true;
    script.defer = true;
    script.onload = callback;
    document.head.appendChild(script);
  }

  function validateInput(fieldType, fieldValue, obj) {
    const value = !Array.isArray(fieldValue)
      ? typeof fieldValue !== "boolean" && fieldValue.trim()
        ? typeof fieldValue !== "boolean" && fieldValue.trim()
        : fieldValue
      : fieldValue;
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    const contactRegex = /^[2-9]{1}[0-9]{9}$/;
    const urlRegex = /^(https?|ftp):\/\/[^\s/$.?#].[^\s]*$/;

    if (Array.isArray(value)) {
      if (value?.length === 0) {
        return validation?.["required"];
      }
    } else {
      if (!value) {
        return validation?.["required"];
      }
    }
    switch (fieldType) {
      case "email":
        if (!emailRegex.test(value)) {
          return validation?.["invalidEmail"];
        } else return "";

      case "confirm_password":
        if (value !== obj.fieldValue) {
          return validation?.["confirmedPasswordMatch"];
        } else return "";

      case "phone":
        if (!contactRegex.test(value)) return validation?.["invalidPhone"];
        else return "";

      case "url":
        if (!urlRegex.test(value)) return validation?.["invalidUrl"];
        else return "";

      default:
        return "";
    }
  }

  const checkValidation = (type, value) => {
    formFieldData = formFieldData.map((item) => {
      if (item.fieldType === type && value) {
        let fieldData = { ...item, fieldValue: value };
        let error = validateInput(fieldData.fieldType, fieldData.fieldValue);
        const errorElement = document.getElementById(`${item.id}_error`);
        errorElement.textContent = error && item.required ? error : "";
        return fieldData;
      } else return item;
    });
  };

  const handleChange = (renderId, event, confirmPassword) => {
    const { id, name, value, type, checked, files } = event.target;
    formData[renderId][name] = value;
    if (type === "radio") {
      if (checked) {
        checkValidation("radio", value);
        formData[renderId][name] = value;
      }
    } else if (type === 'file') {
      const fileList = Array.from(files);
      formFieldData = formFieldData.map((item) => {
        let fieldData = {};
        fieldData = {
          ...item,
          fieldValue: fileList,
          fieldName: name
        }
        let error = validateInput(
          fieldData.fieldName,
          fieldData.fieldValue
        );
        const errorElement = document.getElementById(`${item.id}_error`);
        errorElement.textContent = error && item.required ? error : "";
        return fieldData;
      })
      formData[renderId][name] = fileList;
    } else {
      formFieldData = formFieldData.map((item) => {
        let fieldData = {};
        if (item.confirmfieldId === name && confirmPassword) {
          fieldData = {
            ...item,
            confirmfieldValue: value,
            confirmfieldName: name.replace(/^[a-z0-9]+_/, ""),
          };
          let error = validateInput(
            fieldData.confirmfieldName,
            fieldData.confirmfieldValue,
            fieldData
          );
          const errorElement = document.getElementById(`${item.id}_CPError`);
          errorElement.textContent = error && item.required ? error : "";
        }
        if (item.fieldId === name) {
          if (type === "checkbox") {
            checkValidation("accept_terms", checked);
            formData[renderId][name] = checked;
            fieldData = { ...item, fieldValue: checked };
          } else fieldData = { ...item, fieldValue: value };
          let error = validateInput(fieldData.fieldType, fieldData.fieldValue);
          const errorElement = document.getElementById(`${item.id}_error`);
          errorElement.textContent = error && item.required ? error : "";
          return fieldData;
        } else return item;
      });
      if (name.replace(/^[a-z0-9]+_/, "") !== "confirm_password") {
        formData[renderId][name] = type === "checkbox" ? checked : value;
      }
    }
  };

  const updateFormData = (renderId) => {
    formElement.map((input) => {
      let field = {};
      let index = formFieldData.findIndex(
        (element) => element.id === input.inputId
      );
      if (input.type !== "editor" && input.type !== "heading") {
        formData[renderId] = {
          ...formData[renderId],
          [`${input.inputId}_${input.id}`]:
            input.attributes?.default_value || "",
        };
        // formData = {
        //     ...formData,
        //     [`${input.inputId}_${input.id}`]: input.attributes?.default_value || "",
        // };
        if (input.type === "password" && input?.attributes?.confirmPassword) {
          field = {
            ...field,
            id: input.inputId,
            fieldId: `${input?.inputId}_${input.id}`,
            fieldValue: input.attributes?.default_value || "",
            fieldType: input.id,
            required: input?.attributes?.required,
            confirmPassword: input?.attributes?.confirmPassword,
            confirmfieldId: `${input?.inputId}_confirm_${input.id}`,
            confirmfieldValue: "",
          };
        }
        field = {
          ...field,
          id: input.inputId,
          fieldId: `${input?.inputId}_${input.id}`,
          fieldValue: input.attributes?.default_value || "",
          fieldType: input.id,
          required: input?.attributes?.required,
        };
        if (index !== -1) {
          formFieldData[index] = field;
        } else {
          formFieldData.push(field);
        }
      }
    });
  };

  const setDefaultValue = () => {
    formElement.forEach((data) => {
      const { id, attributes, inputId } = data;
      const initialErrorElement = document.getElementById(`${inputId}_error`);
      const confirmPasswordError =
        attributes.confirmPassword &&
        document.getElementById(`${inputId}_CPError`);
      const captchaError = document.getElementById("captcha_error");
      captchaError.textContent = "";
      if (attributes.confirmPassword) confirmPasswordError.textContent = "";
      if (id === "radio") {
        const redioElements = document.querySelectorAll(
          `input[name="${data?.inputId}_${data?.id}"]`
        );
        for (let radio of redioElements) {
          if (attributes?.default_value === radio.value) {
            radio.checked = true;
          }
        }
      } else if (id === "checkbox") {
        const hobbiesCheckboxes = document.querySelectorAll(
          `input[name="${data?.inputId}_${data?.id}"]`
        );
        for (let checkbox of hobbiesCheckboxes) {
          for (let { value } of attributes?.default_value) {
            if (value === checkbox.value) {
              checkbox.checked = true;
            }
          }
        }
      } else if (id === "dropdown") {
        const selectOptions = document.getElementById(`${data?.inputId}`);
        selectOptions.value = attributes?.default_value;
      }
      initialErrorElement.textContent = "";
    });
  };

  const handleSubmit = async (event, buttonText, formId) => {
    event.preventDefault();
    const banner = document.getElementById(bannerElementId);
    banner.style.display = "none";
    let accept_terms = false;
    let hasError = false;
    const form = document.getElementById(formElementId);
    formFieldData.forEach((input) => {
      if (input.confirmPassword) {
        const errorMessage = validateInput(
          input.fieldType,
          input.fieldValue,
          input
        );
        const errorElement = document.getElementById(`${input.id}_CPError`);
        if (errorMessage !== "" && input.required) {
          hasError = true;
          errorElement.textContent = errorMessage;
        } else errorElement.textContent = "";
      }
      if (input.fieldType === "accept_terms")
        accept_terms = input.fieldValue === "" ? false : input.fieldValue;
      else accept_terms = null;

      const errorMessage = validateInput(input.fieldType, input.fieldValue);
      const errorElement = document.getElementById(`${input.id}_error`);
      if (errorElement) {
        if (errorMessage !== "" && input.required) {
          hasError = true;
          errorElement.textContent = errorMessage;
        } else errorElement.textContent = "";
      }
    });
    const captchaError = document.getElementById("captcha_error");
    captchaError.textContent = recaptcha_response === "" ? "please varify Captcha" : "";
    if (enableRecaptcha) {
      hasError = recaptcha_response !== "" ? false : true
    }

    if ((!hasError && accept_terms) || (!hasError && accept_terms === null)) {
      const loader = document.getElementById(loaderElementId);
      const buttonElement = document.querySelector(`#${submitButtonId}`);
      const buttonTextElement = buttonElement.querySelector(
        "#span_submit_button"
      );
      const originalButtonHeight = buttonElement.clientHeight;
      buttonTextElement.style.display = "none";
      buttonElement.style.height = `${originalButtonHeight}px`;

      const buttonWidth = buttonElement.offsetWidth;
      const loaderSize = 25;
      const loaderLeftPosition = (buttonWidth - loaderSize) / 2;
      const loaderTopPosition = (buttonElement.offsetHeight - loaderSize) / 2;

      loader.style.position = "absolute";
      loader.style.left = `${loaderLeftPosition}px`;
      loader.style.top = `${loaderTopPosition}px`;
      loader.style.display = "block";
      loader.style.zIndex = 10000;

      try {
        const response = await createSubmission(
          formData[formElementId],
          formId
        );
        if (response.ok) {
          buttonTextElement.style.display = "block";
          loader.style.display = "none";
          if (afterSubmit.submitAction === "clearForm") {
            updateFormData(formElementId);
            banner.style.display = "flex";
            form.reset();
            setTimeout(() => {
              window.location.reload();
            }, 3000);
          } else if (afterSubmit.submitAction === "hideForm") {
            form.style.display = "none";
            banner.style.display = "flex";
            setTimeout(() => {
              window.location.reload();
            }, 3000);
          } else if (afterSubmit.submitAction === "pageRedirect") {
            window.open(afterSubmit.redirectUrl, "_blank");
            banner.style.display = "flex";
            // window.location.reload();
          } else alert("submission addeed");
        } else {
          alert("API request failed. Please try again later.");
        }
      } catch (error) {
        console.error("An error occurred:", error);
      } finally {
        buttonElement.textContent = buttonText;
        loader.style.display = "none";
      }
    }
  };
  const headerFieldData = data?.elementData?.customForm[1].header;
  const formElementData = data?.elementData?.customForm[2].element;
  const footerFieldData = data?.elementData?.customForm[4].footer;
  const appearanceFields = handleAppereance(data?.appearanceData);
  const validationFields = handleAppereance(data?.validationData);
  const afterSubmitFields = handleAppereance(data?.afterSubmit);
  const mainFormElement = data.element;
  const user = data.user;
  formElement = formElementData;
  validation = validationFields;
  afterSubmit = afterSubmitFields;

  updateFormData(formElementId);
  let selectedBackground =
    appearanceFields && appearanceFields?.appearanceBackground;
  let footerAlign = footerFieldData?.attributes?.footerAlign;

  let inputStyles = {};
  let appearanceStyle = appearanceFields && appearanceFields?.appearanceStyle;
  if (appearanceStyle === "classicRounded") {
    inputStyles.borderRadius = "20px";
  } else if (appearanceStyle === "flat") {
    inputStyles.boxShadow = "none";
    inputStyles.border = '0.5px solid lightgrey';
    inputStyles.background = 'none';
  }
  else if (appearanceStyle === "flatRounded") {
    inputStyles.borderRadius = "20px";
    inputStyles.background = 'none';
    inputStyles.boxShadow = 'none';
    inputStyles.border = '0.5px solid lightgrey';
  }

  const checkPlan = elements(user.subscriptionName, formElementData, true);
  if (checkPlan.length > 0) {
    setTimeout(() => {
      const divElement = document.createElement("div");
      divElement.className = `${selectedBackground === 'none' ? 'formBuilderNone' : 'formBuilder'} ${selectedBackground === "image" ? "formImageBackground" : ""
        }`;

      divElement.style.maxWidth = appearanceFields?.appearanceWidth || "700px";
      divElement.style.backgroundColor =
        selectedBackground === "color" && appearanceFields?.formBackgroundColor
          ? appearanceFields?.formBackgroundColor
          : selectedBackground === "none"
            ? "transparent"
            : "#fff";
      divElement.style.backgroundImage =
        selectedBackground === "image"
          ? `url(${appearanceFields?.backgroundImageUrl})`
          : "";
      divElement.style.backgroundPosition = appearanceFields?.imageAlignment
        ? appearanceFields?.imageAlignment === "middle"
          ? "center"
          : `${appearanceFields?.imageAlignment}`
        : "top";

      mainFormElement.appendChild(divElement);
      const formElement = document.createElement("form");
      formElement.className = "formContainer";
      formElement.id = formElementId;
      formElement.noValidate = emailValidate;
      formElement.enctype = "multipart/form-data";

      formElement.addEventListener("submit", (event) => {
        handleSubmit(
          event,
          footerFieldData?.attributes?.submitButton,
          data?.elementData?._id
        );
      });
      divElement.appendChild(formElement);

      if (headerFieldData) {
        if (headerFieldData?.attributes?.showHeader) {
          const headerDivElement = document.createElement("div");
          headerDivElement.className = "header";
          formElement.appendChild(headerDivElement);

          const headerElement = document.createElement("h3");
          headerElement.id = headerFieldData.id;
          headerElement.className = "formTitle";
          headerElement.textContent = headerFieldData?.attributes?.title;
          headerElement.style.color = appearanceFields?.headingColor;
          headerDivElement.appendChild(headerElement);

          const headerDescription = document.createElement("div");
          headerDescription.className = "headerDescription";
          headerDescription.textContent =
            headerFieldData?.attributes?.description;
          headerDescription.style.color = appearanceFields?.descriptionColor;
          headerDivElement.appendChild(headerDescription);
        }
      }
      const gridElement = document.createElement("div");
      gridElement.className = "grid-container";
      formElement.appendChild(gridElement);

      elements(user.subscriptionName, formElementData, true)?.forEach(
        (item) => {
          const {
            label,
            placeholder,
            description,
            limit_chars,
            limit_chars_count,
            required,
            column_width,
            options,
            radio_options,
            hideDivider,
            hideLabel,
            allowedExtensions,
            allowMultiple,
            hiddenValue,
            htmlCode,
            no_of_options,
            text,
            heading,
            caption,
            dateTimeFormat,
            dateFormat,
            timeFormat,
            dropdown_options,
            default_value,
            confirmPassword,
            confirmPasswordLabel,
            confirmPasswordPlaceholder,
            confirmPasswordDescription,
            resizeTextarea,
          } = item?.attributes || {};
          const width = {
            md:
              column_width === "33%"
                ? 4
                : column_width === "50%"
                  ? 6
                  : column_width === "100%" && 12,
            xl:
              column_width === "33%"
                ? 4
                : column_width === "50%"
                  ? 6
                  : column_width === "100%" && 12,
          };

          const noOfOptions = parseInt(no_of_options?.[0]);
          const inputWidth = 100 / noOfOptions + "%";
          const widthInput = "100%";

          const innerDivElement = document.createElement("div");
          innerDivElement.className = "grid-item";
          innerDivElement.style.gridColumn = `span ${width.xl}`;
          gridElement.appendChild(innerDivElement);

          if (
            item.type === "text" ||
            item.type === "email" ||
            item.type === "number"
          ) {
            emailValidate = item.type === "email" && required ? false : true;
            const inputContainer = document.createElement("div");
            inputContainer.className = "inputContainer";
            innerDivElement.appendChild(inputContainer);

            const labelElement = document.createElement("label");
            labelElement.htmlFor = item.inputId;
            labelElement.className = "classicLabel";
            labelElement.style.color = appearanceFields?.labelColor
              ? appearanceFields?.labelColor
              : "";
            labelElement.textContent = hideLabel ? "" : label;
            inputContainer.appendChild(labelElement);

            const requiredElement = document.createElement("span");
            requiredElement.className = "textRequired";
            requiredElement.textContent = required ? " *" : "";
            labelElement.appendChild(requiredElement);

            const brElement = document.createElement("br");
            inputContainer.appendChild(brElement);

            const inputElement = document.createElement("input");
            inputElement.type = item.type;
            inputElement.id = item.inputId;
            inputElement.setAttribute(
              "data-id",
              `${formElementId}_${item?.inputId}`
            );
            inputElement.className = "classicInput";

            inputElement.name = `${item.inputId}_${item.id}`;
            inputElement.min = 0;

            inputElement.placeholder = placeholder;
            inputElement.autocomplete = "off";

            inputElement.style.width = widthInput;
            Object.assign(inputElement.style, inputStyles);
            inputContainer.appendChild(inputElement);
            const element = document.querySelector(
              `input[data-id=${formElementId}_${item?.inputId}]`
            );
            element.addEventListener("input", (e) =>
              handleChange(formElementId, e)
            );

            const descriptionElement = document.createElement("span");
            descriptionElement.className = "description";
            descriptionElement.textContent = description;
            inputContainer.appendChild(descriptionElement);

            const smallElement = document.createElement("small");
            const errorMessageElement = document.createElement("p");
            errorMessageElement.className = "errorMessage";
            errorMessageElement.id = `${item.inputId}_error`;

            smallElement.appendChild(errorMessageElement);
            inputContainer.appendChild(smallElement);
          } else if (item?.type === "file") {
            const acceptExtensions = allowedExtensions
              ?.map((extension) => `.${extension.value}`)
              .join(",");

            const inputContainer = document.createElement("div");
            inputContainer.className = "inputContainer";
            innerDivElement.appendChild(inputContainer);

            const labelElement = document.createElement("label");
            labelElement.htmlFor = item.inputId;
            labelElement.className = "classicLabel";
            labelElement.style.color = appearanceFields?.labelColor
              ? appearanceFields.labelColor
              : "";
            labelElement.textContent = hideLabel ? "" : item.title;
            inputContainer.appendChild(labelElement);

            const requiredElement = document.createElement("span");
            requiredElement.className = "textRequired";
            requiredElement.textContent = required ? " *" : "";
            labelElement.appendChild(requiredElement);

            const brElement = document.createElement("br");
            inputContainer.appendChild(brElement);

            const fileInputElement = document.createElement("input");
            fileInputElement.type = item.type;
            fileInputElement.id = item.inputId;
            fileInputElement.setAttribute(
              "data-id",
              `${formElementId}_${item?.inputId}`
            );
            fileInputElement.className = "classicInput";
            // fileInputElement.value = formSubmissionData[`${item.inputId}_${item.id}`];
            fileInputElement.name = `${item.inputId}_${item.id}`;
            fileInputElement.accept = acceptExtensions;
            fileInputElement.min = 0;
            fileInputElement.required = "";
            fileInputElement.placeholder = placeholder;
            fileInputElement.autocomplete = "off";
            // fileInputElement.maxLength = limit_chars ? limit_chars_count : 20;
            fileInputElement.style.width = widthInput;
            Object.assign(fileInputElement.style, inputStyles);
            fileInputElement.multiple = allowMultiple ? true : false;
            inputContainer.appendChild(fileInputElement);
            const element = document.querySelector(
              `input[data-id=${formElementId}_${item?.inputId}]`
            );

            element.addEventListener("input", (e) =>
              handleChange(formElementId, e)
            );
            // const element = document.getElementById(item.inputId)
            // element.addEventListener("input", handleChange);
            const fileDescriptionElement = document.createElement("span");
            fileDescriptionElement.className = "description";
            fileDescriptionElement.textContent = description;
            inputContainer.appendChild(fileDescriptionElement);

            const smallElement = document.createElement("small");
            const errorMessageElement = document.createElement("p");
            errorMessageElement.className = "errorMessage";
            errorMessageElement.id = `${item.inputId}_error`;
            // errorMessageElement.textContent = required ? formFeildData[index]?.errorMessage : null;
            smallElement.appendChild(errorMessageElement);
            inputContainer.appendChild(smallElement);
          } else if (item?.type === "password") {
            const inputContainer = document.createElement("div");
            inputContainer.className = "inputContainer";
            innerDivElement.appendChild(inputContainer);

            const labelElement = document.createElement("label");
            labelElement.htmlFor = item.inputId;
            labelElement.className = "classicLabel";
            labelElement.style.color = appearanceFields?.labelColor
              ? appearanceFields.labelColor
              : "";
            labelElement.textContent = hideLabel ? "" : label;
            inputContainer.appendChild(labelElement);

            const requiredElement = document.createElement("span");
            requiredElement.className = "textRequired";
            requiredElement.textContent = required ? " *" : "";
            labelElement.appendChild(requiredElement);

            const brElement = document.createElement("br");
            inputContainer.appendChild(brElement);

            const passwordInputElement = document.createElement("input");
            passwordInputElement.type = item.type;
            passwordInputElement.id = item.inputId;
            passwordInputElement.setAttribute(
              "data-id",
              `${formElementId}_${item?.inputId}`
            );
            passwordInputElement.className = "classicInput";

            passwordInputElement.name = `${item.inputId}_${item.id}`;
            passwordInputElement.min = 0;
            passwordInputElement.required = "";
            passwordInputElement.placeholder = placeholder;
            passwordInputElement.autocomplete = "off";
            // passwordInputElement.maxLength = limit_chars ? limit_chars_count : "";
            passwordInputElement.style.width = widthInput;
            Object.assign(passwordInputElement.style, inputStyles);

            inputContainer.appendChild(passwordInputElement);
            const element = document.querySelector(
              `input[data-id=${formElementId}_${item?.inputId}]`
            );
            element.addEventListener("input", (e) =>
              handleChange(formElementId, e)
            );

            const passwordDescriptionElement = document.createElement("span");
            passwordDescriptionElement.className = "description";
            passwordDescriptionElement.textContent = description;
            inputContainer.appendChild(passwordDescriptionElement);

            const smallElement = document.createElement("small");
            const errorMessageElement = document.createElement("p");
            errorMessageElement.className = "errorMessage";
            errorMessageElement.id = `${item.inputId}_error`;

            smallElement.appendChild(errorMessageElement);
            inputContainer.appendChild(smallElement);

            if (confirmPassword) {
              const inputContainer = document.createElement("div");
              inputContainer.className = "inputContainer";
              innerDivElement.appendChild(inputContainer);

              const labelElement = document.createElement("label");
              labelElement.htmlFor = item.inputId;
              labelElement.className = "classicLabel";
              labelElement.style.color = appearanceFields?.labelColor
                ? appearanceFields.labelColor
                : "";
              labelElement.textContent = hideLabel ? "" : confirmPasswordLabel;
              inputContainer.appendChild(labelElement);

              const requiredElement = document.createElement("span");
              requiredElement.className = "textRequired";
              requiredElement.textContent = required ? " *" : "";
              labelElement.appendChild(requiredElement);

              const brElement = document.createElement("br");
              inputContainer.appendChild(brElement);

              const confirmPasswordInputElement =
                document.createElement("input");
              confirmPasswordInputElement.type = item.type;
              confirmPasswordInputElement.id = `confirm_${item.inputId}`;
              confirmPasswordInputElement.setAttribute(
                "data-id",
                `${formElementId}_${item?.inputId}`
              );
              confirmPasswordInputElement.className = "classicInput";
              confirmPasswordInputElement.name = `${item.inputId}_confirm_${item.id}`;
              confirmPasswordInputElement.placeholder =
                confirmPasswordPlaceholder;
              confirmPasswordInputElement.autocomplete = "off";
              confirmPasswordInputElement.required = "";
              // confirmPasswordInputElement.maxLength = limit_chars ? limit_chars_count  : "";
              confirmPasswordInputElement.style.width = widthInput;
              Object.assign(confirmPasswordInputElement.style, inputStyles);

              inputContainer.appendChild(confirmPasswordInputElement);
              const element = document.querySelector(
                `input[data-id=${formElementId}_${item?.inputId}]`
              );
              element.addEventListener("input", (event) =>
                handleChange(formElementId, event, confirmPassword)
              );

              const confirmPasswordDescriptionElement =
                document.createElement("span");
              confirmPasswordDescriptionElement.className = "description";
              confirmPasswordDescriptionElement.textContent =
                confirmPasswordDescription;
              inputContainer.appendChild(confirmPasswordDescriptionElement);

              const confirmPasswordSmallElement =
                document.createElement("small");
              const confirmPasswordErrorMessageElement =
                document.createElement("p");
              confirmPasswordErrorMessageElement.className = "errorMessage";
              confirmPasswordErrorMessageElement.id = `${item.inputId}_CPError`;

              confirmPasswordSmallElement.appendChild(
                confirmPasswordErrorMessageElement
              );
              inputContainer.appendChild(confirmPasswordSmallElement);
            }
          } else if (item?.type === "textarea") {
            const inputContainer = document.createElement("div");
            inputContainer.className = "inputContainer";
            innerDivElement.appendChild(inputContainer);

            const labelElement = document.createElement("label");
            labelElement.htmlFor = item.inputId;
            labelElement.className = "classicLabel";
            labelElement.style.color = appearanceFields?.labelColor
              ? appearanceFields.labelColor
              : "";
            labelElement.textContent = hideLabel ? "" : label;
            inputContainer.appendChild(labelElement);

            const requiredElement = document.createElement("span");
            requiredElement.className = "textRequired";
            requiredElement.textContent = required ? " *" : "";
            labelElement.appendChild(requiredElement);

            const brElement = document.createElement("br");
            inputContainer.appendChild(brElement);

            const textareaInputElement = document.createElement("textarea");
            textareaInputElement.placeholder = placeholder;
            textareaInputElement.id = item.inputId;
            textareaInputElement.setAttribute(
              "data-id",
              `${formElementId}_${item?.inputId}`
            );
            textareaInputElement.rows = 3;
            textareaInputElement.name = `${item.inputId}_${item.id}`;
            textareaInputElement.className = "classicInput";
            textareaInputElement.required = "";
            textareaInputElement.style.width = widthInput;
            Object.assign(textareaInputElement.style, inputStyles);
            textareaInputElement.style.resize = resizeTextarea
              ? "vertical"
              : "none";
            textareaInputElement.style.maxHeight = "200px";
            textareaInputElement.style.minHeight = "80px";
            inputContainer.appendChild(textareaInputElement);
            const element = document.querySelector(
              `textarea[data-id=${formElementId}_${item?.inputId}]`
            );
            element.addEventListener("input", (e) =>
              handleChange(formElementId, e)
            );

            const textareaDescriptionElement = document.createElement("span");
            textareaDescriptionElement.className = "description";
            textareaDescriptionElement.textContent = description;
            inputContainer.appendChild(textareaDescriptionElement);

            const textareaSmallElement = document.createElement("small");
            const textareaErrorMessageElement = document.createElement("p");
            textareaErrorMessageElement.className = "errorMessage";
            textareaErrorMessageElement.id = `${item.inputId}_error`;
            textareaSmallElement.appendChild(textareaErrorMessageElement);
            inputContainer.appendChild(textareaSmallElement);
          } else if (item?.type === "checkbox") {
            if (item?.id === "accept_terms") {
              const checkboxContainer = document.createElement("div");
              checkboxContainer.className = "inputContainer";
              innerDivElement.appendChild(checkboxContainer);

              const checkboxWrapperElement = document.createElement("div");
              checkboxWrapperElement.style.width = widthInput;
              checkboxWrapperElement.className = "checkBoxWrapper";
              checkboxContainer.appendChild(checkboxWrapperElement);

              const checkboxInputElement = document.createElement("input");
              checkboxInputElement.className = "checkBoxInput";
              checkboxInputElement.id = item?.inputId;
              checkboxInputElement.setAttribute(
                "data-id",
                `${formElementId}_${item?.inputId}`
              );
              checkboxInputElement.type = item?.type;
              checkboxInputElement.name = `${item?.inputId}_${item?.id}`;

              checkboxWrapperElement.appendChild(checkboxInputElement);

              const checkboxLabelElement = document.createElement("label");
              checkboxLabelElement.className = "checkBoxLabel checkbox-label";
              checkboxLabelElement.htmlFor = item?.inputId;
              checkboxWrapperElement.appendChild(checkboxLabelElement);

              const labelContentElement = document.createElement("span");
              labelContentElement.className = "labelContent";
              labelContentElement.style.color = appearanceFields?.labelColor
                ? appearanceFields.labelColor
                : "";
              labelContentElement.innerHTML = label;
              checkboxLabelElement.appendChild(labelContentElement);

              const textRequiredElement = document.createElement("span");
              textRequiredElement.className = "textRequired";
              textRequiredElement.textContent = required ? " *" : "";
              checkboxWrapperElement.appendChild(textRequiredElement);

              const descriptionElement = document.createElement("span");
              descriptionElement.className = "description";
              descriptionElement.textContent = description;
              checkboxContainer.appendChild(descriptionElement);

              const smallElement = document.createElement("small");
              const errorMessageElement = document.createElement("p");
              errorMessageElement.className = "errorMessage";
              errorMessageElement.id = `${item.inputId}_error`;
              smallElement.appendChild(errorMessageElement);
              checkboxContainer.appendChild(smallElement);
              const element = document.querySelector(
                `input[data-id=${formElementId}_${item?.inputId}]`
              );
              element.addEventListener("change", (e) =>
                handleChange(formElementId, e)
              );
            } else {
              const checkboxContainer = document.createElement("div");
              checkboxContainer.className = "inputContainer";
              innerDivElement.appendChild(checkboxContainer);

              const labelElement = document.createElement("label");
              labelElement.htmlFor = item?.inputId;
              labelElement.className = "classicLabel";
              labelElement.style.color = appearanceFields?.labelColor
                ? appearanceFields.labelColor
                : "";
              labelElement.textContent = hideLabel ? "" : label;
              checkboxContainer.appendChild(labelElement);

              const textRequiredElement = document.createElement("span");
              textRequiredElement.className = "textRequired";
              textRequiredElement.textContent = required ? " *" : "";
              checkboxContainer.appendChild(textRequiredElement);

              const ulElement = document.createElement("ul");
              ulElement.style.listStyleType = "none";
              ulElement.id = "checkbox123";
              ulElement.style.margin = 0;
              ulElement.style.padding = 0;
              ulElement.style.width = widthInput;
              ulElement.style.display = "flex";
              ulElement.style.flexWrap = "wrap";
              checkboxContainer.appendChild(ulElement);

              options?.forEach((option) => {
                const liElement = document.createElement("li");
                liElement.style.width = inputWidth;
                ulElement.appendChild(liElement);

                const checkBoxWrapperElement = document.createElement("div");
                checkBoxWrapperElement.className = "checkBoxWrapper";
                liElement.appendChild(checkBoxWrapperElement);

                const checkBoxLabelElement = document.createElement("label");
                checkBoxLabelElement.className = "checkBoxLabel";
                checkBoxLabelElement.style.color = appearanceFields?.optionColor
                  ? appearanceFields.optionColor
                  : "";
                checkBoxWrapperElement.appendChild(checkBoxLabelElement);

                const checkBoxInputElement = document.createElement("input");
                checkBoxInputElement.className = "checkBoxInput";
                checkBoxInputElement.type = item?.type;
                checkBoxInputElement.value = option.value;
                checkBoxInputElement.id = `${item?.inputId}_${option.label
                  .replace(/\s+/g, "-")
                  .replace(/[^a-zA-Z0-9-_]/g, "")}`;

                checkBoxInputElement.setAttribute(
                  "data-id",
                  `${formElementId}_${item?.inputId}_${option.label
                    .replace(/\s+/g, "-")
                    .replace(/[^a-zA-Z0-9-_]/g, "")}`
                );
                checkBoxInputElement.name = `${item?.inputId}_${item?.id}`;
                checkBoxLabelElement.appendChild(checkBoxInputElement);

                checkBoxLabelElement.appendChild(
                  document.createTextNode(option.label)
                );

                const element = document.querySelector(
                  `input[data-id=${formElementId}_${item?.inputId
                  }_${option.label
                    .replace(/\s+/g, "-")
                    .replace(/[^a-zA-Z0-9-_]/g, "")}]`
                );
                element.addEventListener("change", (event) => {
                  const selectedCheckboxes = ulElement.querySelectorAll(
                    'input[type="checkbox"]:checked'
                  );
                  const selectedValues = Array.from(selectedCheckboxes).map(
                    (checkbox) => {
                      let checkValue = {
                        label: checkbox.value,
                        value: checkbox.value,
                      };
                      return checkValue;
                    }
                  );
                  formData[formElementId][event.target.name] = selectedValues;
                  checkValidation("checkbox", selectedValues);
                });
              });
              const descriptionElement = document.createElement("span");
              descriptionElement.className = "description";
              descriptionElement.textContent = description;
              checkboxContainer.appendChild(descriptionElement);

              const smallElement = document.createElement("small");
              const errorMessageElement = document.createElement("p");
              errorMessageElement.className = "errorMessage";
              errorMessageElement.id = `${item.inputId}_error`;
              smallElement.appendChild(errorMessageElement);
              checkboxContainer.appendChild(smallElement);
              if (default_value) {
                const hobbiesCheckboxes = document.querySelectorAll(
                  `input[name="${item?.inputId}_${item?.id}"]`
                );
                for (let checkbox of hobbiesCheckboxes) {
                  for (let { label, value } of default_value) {
                    if (value === checkbox.value) {
                      checkbox.checked = true;
                    }
                  }
                }
              }
            }
          } else if (item?.type === "radio") {
            const radioContainer = document.createElement("div");
            radioContainer.className = "inputContainer";
            innerDivElement.appendChild(radioContainer);

            const labelElement = document.createElement("label");
            labelElement.htmlFor = item?.inputId;
            labelElement.className = "classicLabel";
            labelElement.style.color = appearanceFields?.labelColor
              ? appearanceFields.labelColor
              : "";
            labelElement.textContent = hideLabel ? "" : label;
            radioContainer.appendChild(labelElement);

            const textRequiredElement = document.createElement("span");
            textRequiredElement.className = "textRequired";
            textRequiredElement.textContent = required ? " *" : "";
            radioContainer.appendChild(textRequiredElement);

            const ulElement = document.createElement("ul");
            ulElement.style.listStyleType = "none";
            ulElement.style.margin = 0;
            ulElement.style.padding = 0;
            ulElement.style.width = widthInput;
            ulElement.style.display = "flex";
            ulElement.style.flexWrap = "wrap";
            radioContainer.appendChild(ulElement);

            radio_options?.forEach((option) => {
              const liElement = document.createElement("li");
              liElement.style.width = inputWidth;
              ulElement.appendChild(liElement);

              const checkBoxWrapperElement = document.createElement("div");
              checkBoxWrapperElement.className = "checkBoxWrapper";
              liElement.appendChild(checkBoxWrapperElement);

              const checkBoxLabelElement = document.createElement("label");
              checkBoxLabelElement.className = "checkBoxLabel";
              checkBoxLabelElement.style.color = appearanceFields?.optionColor
                ? appearanceFields.optionColor
                : "";
              checkBoxWrapperElement.appendChild(checkBoxLabelElement);

              const checkBoxInputElement = document.createElement("input");
              checkBoxInputElement.className = "checkBoxInput";
              checkBoxInputElement.type = item?.type;
              checkBoxInputElement.value = option.value;
              checkBoxInputElement.id = `${item?.inputId}_${option.label
                .replace(/\s+/g, "-")
                .replace(/[^a-zA-Z0-9-_]/g, "")}`;
              checkBoxInputElement.setAttribute(
                "data-id",
                `${formElementId}_${item?.inputId}_${option.label
                  .replace(/\s+/g, "-")
                  .replace(/[^a-zA-Z0-9-_]/g, "")}`
              );
              checkBoxInputElement.name = `${item?.inputId}_${item?.id}`;
              checkBoxInputElement.defaultChecked = default_value;
              checkBoxLabelElement.appendChild(checkBoxInputElement);

              checkBoxLabelElement.appendChild(
                document.createTextNode(option.label)
              );

              const element = document.querySelector(
                `input[data-id=${formElementId}_${item?.inputId}_${option.label
                  .replace(/\s+/g, "-")
                  .replace(/[^a-zA-Z0-9-_]/g, "")}]`
              );
              element.addEventListener("change", (event) => {
                const selectedRadio = ulElement.querySelector(
                  'input[type="radio"]:checked'
                );
                if (selectedRadio) {
                  const selectedValue = selectedRadio.value;
                  formData[formElementId][event.target.name] = selectedValue;
                  // formData[event.target.name] = selectedValue;
                  checkValidation("radio", selectedValue);
                }
              });
            });

            const descriptionElement = document.createElement("span");
            descriptionElement.className = "description";
            descriptionElement.textContent = description;
            radioContainer.appendChild(descriptionElement);

            const smallElement = document.createElement("small");
            const errorMessageElement = document.createElement("p");
            errorMessageElement.className = "errorMessage";
            errorMessageElement.id = `${item.inputId}_error`;
            smallElement.appendChild(errorMessageElement);
            radioContainer.appendChild(smallElement);
            if (default_value) {
              const radioButtons = document.querySelectorAll(
                `input[name="${item?.inputId}_${item?.id}"]`
              );
              for (let radio of radioButtons) {
                if (default_value === radio.value) {
                  radio.checked = true;
                }
              }
            }
          } else if (item?.type === "select") {
            const selectContainer = document.createElement("div");
            selectContainer.className = "inputContainer";
            innerDivElement.appendChild(selectContainer);

            const labelElement = document.createElement("label");
            labelElement.htmlFor = item?.inputId;
            labelElement.className = "classicLabel";
            labelElement.style.color = appearanceFields?.labelColor
              ? appearanceFields.labelColor
              : "";
            labelElement.textContent = hideLabel ? "" : label;
            selectContainer.appendChild(labelElement);

            const textRequiredElement = document.createElement("span");
            textRequiredElement.className = "textRequired";
            textRequiredElement.textContent = required ? " *" : "";
            selectContainer.appendChild(textRequiredElement);

            const selectElement = document.createElement("select");
            selectElement.name = `${item?.inputId}_${item?.id}`;
            selectElement.id = item?.inputId;
            selectElement.setAttribute(
              "data-id",
              `${formElementId}_${item?.inputId}`
            );
            selectElement.className = "classicInput";
            selectElement.style.width = widthInput;
            Object.assign(selectElement.style, inputStyles);
            selectContainer.appendChild(selectElement);
            const element = document.querySelector(
              `select[data-id=${formElementId}_${item?.inputId}]`
            );
            element.addEventListener("change", (e) =>
              handleChange(formElementId, e)
            );

            const defaultOptionElement = document.createElement("option");
            defaultOptionElement.value = "";
            defaultOptionElement.disabled = true;
            defaultOptionElement.selected = true;
            defaultOptionElement.textContent = placeholder;
            selectElement.appendChild(defaultOptionElement);

            dropdown_options?.forEach((option) => {
              const optionElement = document.createElement("option");
              optionElement.value = option.value;
              optionElement.textContent = option.label;
              selectElement.appendChild(optionElement);
            });

            const descriptionElement = document.createElement("span");
            descriptionElement.className = "description";
            descriptionElement.textContent = description;
            selectContainer.appendChild(descriptionElement);

            const smallElement = document.createElement("small");
            const errorMessageElement = document.createElement("p");
            errorMessageElement.className = "errorMessage";
            errorMessageElement.id = `${item.inputId}_error`;
            smallElement.appendChild(errorMessageElement);
            selectContainer.appendChild(smallElement);
            if (default_value) {
              const selectOptions = document.getElementById(`${item?.inputId}`);
              selectOptions.value = default_value;
            }
          } else if (item?.type === "divider") {
            if (!hideDivider) {
              const hrElement = document.createElement("hr");
              hrElement.className = "divider";
              innerDivElement.appendChild(hrElement);
            }
          } else if (item?.type === "hidden") {
            const hiddenContainer = document.createElement("div");
            hiddenContainer.className = "inputContainer";
            hiddenContainer.style.display = "none";
            hiddenContainer.style.visibility = "hidden";
            innerDivElement.appendChild(hiddenContainer);

            const labelElement = document.createElement("label");
            labelElement.htmlFor = item?.inputId;
            labelElement.className = "classicLabel";
            hiddenContainer.appendChild(labelElement);

            const spanElement = document.createElement("span");
            spanElement.dataset.label = "Hidden";
            spanElement.textContent = label;
            labelElement.appendChild(spanElement);

            const inputElement = document.createElement("input");
            inputElement.type = item?.type;
            inputElement.dataset.type = "fixed";
            inputElement.id = item?.inputId;
            inputElement.name = `${item?.inputId}_${item?.id}`;
            inputElement.value = hiddenValue;
            hiddenContainer.appendChild(inputElement);
          } else if (item?.type === "editor") {
            const editorContainer = document.createElement("div");
            editorContainer.className = "inputContainer";
            innerDivElement.appendChild(editorContainer);

            const paragraphInput = document.createElement("div");
            paragraphInput.className = "paragraphInput";
            paragraphInput.style.width = widthInput;
            paragraphInput.style.color = appearanceFields?.paragraphColor
              ? appearanceFields.paragraphColor
              : "";
            paragraphInput.style.background =
              appearanceFields?.paragraphBackgroundColor
                ? appearanceFields.paragraphBackgroundColor
                : "";
            paragraphInput.innerHTML = text;
            editorContainer.appendChild(paragraphInput);
          } else if (item?.type === "heading") {
            const headingContainer = document.createElement("div");
            headingContainer.className = "inputContainer";
            innerDivElement.appendChild(headingContainer);

            const headingTitle = document.createElement("h3");
            headingTitle.className = "headingTitle";
            headingTitle.innerHTML = heading;
            headingContainer.appendChild(headingTitle);

            const headingCaption = document.createElement("p");
            headingCaption.className = "headingCaption";
            headingCaption.innerHTML = caption;
            headingContainer.appendChild(headingCaption);
          } else if (item?.type === "HTML") {
            const htmlContainer = document.createElement("div");
            htmlContainer.className = "inputContainer";
            innerDivElement.appendChild(htmlContainer);

            const htmlContent = document.createElement("div");
            htmlContent.innerHTML = htmlCode ? htmlCode : caption;
            htmlContainer.appendChild(htmlContent);
          } else if (item?.type === "date") {
            const dateContainer = document.createElement("div");
            dateContainer.className = "inputContainer";
            innerDivElement.appendChild(dateContainer);
            const labelElement = document.createElement("label");
            labelElement.htmlFor = item.inputId;
            labelElement.className = "classicLabel";
            labelElement.style.color = appearanceFields?.labelColor
              ? appearanceFields?.labelColor
              : "";
            labelElement.textContent = hideLabel ? "" : item.title;
            dateContainer.appendChild(labelElement);

            const requiredElement = document.createElement("span");
            requiredElement.className = "textRequired";
            requiredElement.textContent = required ? " *" : "";
            labelElement.appendChild(requiredElement);

            const brElement = document.createElement("br");
            dateContainer.appendChild(brElement);

            const inputElement = document.createElement("input");
            inputElement.type = item.type;
            inputElement.id = `datepicker_${item.inputId}`;
            inputElement.setAttribute(
              "data-id",
              `${formElementId}_${item?.inputId}`
            );
            inputElement.className = "classicInput";
            // inputElement.value = formSubmissionData[`${item.inputId}_${item.id}`];
            inputElement.value = "";
            inputElement.name = `${item.inputId}_${item.id}`;
            inputElement.min = 0;
            inputElement.required = "";
            inputElement.placeholder = placeholder;
            inputElement.autocomplete = "off";
            // inputElement.maxLength = limit_chars ? limit_chars_count : undefined;
            inputElement.style.width = widthInput;
            Object.assign(inputElement.style, inputStyles);
            // const element = document.querySelector(
            //   `input[data-id=${formElementId}_${item?.inputId}]`
            //   );
            //   console.log('dateeee: ', element);
            // element.addEventListener("change", (e) =>
            //   handleChange(formElementId, e)
            // );
            // inputElement.addEventListener("change", (event) => handleChange(event));
            dateContainer.appendChild(inputElement);

            const descriptionElement = document.createElement("span");
            descriptionElement.className = "description";
            descriptionElement.textContent = description;
            dateContainer.appendChild(descriptionElement);

            const smallElement = document.createElement("small");
            const errorMessageElement = document.createElement("p");
            errorMessageElement.className = "errorMessage";
            errorMessageElement.id = `${item.inputId}_error`;
            // errorMessageElement.textContent = required ? formFeildData[index]?.errorMessage : null;
            smallElement.appendChild(errorMessageElement);
            dateContainer.appendChild(smallElement);
            const datepicker = document.getElementById(
              `datepicker_${item.inputId}`
            );
            datepicker.addEventListener("input", (e) =>
              handleChange(formElementId, e)
            );
            const timeFormatValue = timeFormat === "24h" ? "H:i" : "h:i K";
            const getOptions = () => {
              if (dateTimeFormat === "1") {
                return {
                  noCalendar: false,
                  enableTime: true,
                  dateFormat: `${dateFormat} ${timeFormatValue}`,
                };
              } else if (dateTimeFormat === "2") {
                return {
                  noCalendar: false,
                  enableTime: false,
                  dateFormat: dateFormat,
                };
              } else if (dateTimeFormat === "3") {
                return {
                  noCalendar: true,
                  enableTime: true,
                  time_24hr: timeFormat === "24h" ? true : false,
                  dateFormat: timeFormatValue,
                };
              }
            };
            const options = getOptions();
            flatpickr(datepicker, {
              key: dateTimeFormat,
              noCalendar: options.noCalendar,
              enableTime: options.enableTime,
              time_24hr: options.time_24hr,
              dateFormat: options.dateFormat,
            });
          }
        }
      );

      if (enableRecaptcha) {
        const captchaContainer = document.createElement("div");
        captchaContainer.className = "captchaContainer";

        const invisibleDiv = document.createElement("div");
        invisibleDiv.style.width = "0";

        const reCaptchaElement = document.createElement("div");
        reCaptchaElement.className = "g-recaptcha";

        reCaptchaElement.setAttribute("data-sitekey", recaptchadata?.siteKey);
        captchaContainer.appendChild(reCaptchaElement);

        const smallElement = document.createElement("small");
        const captchaErrorMsgElement = document.createElement("p");
        captchaErrorMsgElement.className = "errorMessage";
        captchaErrorMsgElement.id = `captcha_error`;

        smallElement.appendChild(captchaErrorMsgElement);
        captchaContainer.appendChild(smallElement);
        formElement.appendChild(captchaContainer);
        formElement.appendChild(invisibleDiv);

        setTimeout(() => {
          grecaptcha.render(reCaptchaElement, {
            sitekey: recaptchadata?.siteKey,
            callback: handleCaptchaChange,
          });
        }, 2000);

        const captchaError = document.getElementById("captcha_error");
        if (enableRecaptcha) {
          captchaContainer.style.display = "";
          captchaError.style.display = "";
        } else {
          captchaContainer.style.display = "none";
          captchaError.style.display = "none";
        }
      }

      if (footerFieldData && footerFieldData?.attributes) {
        const footerDivElement = document.createElement("div");
        footerDivElement.style.textAlign = footerFieldData?.attributes
          ?.buttonWidth
          ? "left"
          : footerAlign[0];
        formElement.appendChild(footerDivElement);

        const footerDescription = document.createElement("div");
        footerDescription.className = "footerDescription";
        footerDivElement.appendChild(footerDescription);

        const footerElement = document.createElement("h5");
        footerElement.id = footerFieldData?.id;
        footerDescription.appendChild(footerElement);

        const footerContent = document.createElement("span");
        footerContent.innerHTML = footerFieldData?.attributes?.text;
        footerElement.appendChild(footerContent);

        // const buttonElement = document.createElement("button");
        // buttonElement.type = "submit";
        // buttonElement.className = `${
        //   footerFieldData?.attributes?.buttonWidth
        //     ? "buttonWidth"
        //     : "classicButton submitButton"
        // }`;
        // buttonElement.style.backgroundColor = appearanceFields?.mainColor;
        // buttonElement.style.border = "none";
        // buttonElement.textContent = footerFieldData?.attributes?.submitButton;
        // footerDivElement.appendChild(buttonElement);
        const buttonElement = document.createElement("button");
        buttonElement.type = "submit";
        buttonElement.className = `${footerFieldData?.attributes?.buttonWidth
          ? "buttonWidth classicButton submitButton"
          : "classicButton submitButton"
          }`;
        const spanSubmit = document.createElement("span");
        spanSubmit.textContent = footerFieldData?.attributes?.submitButton;
        spanSubmit.id = "span_submit_button";
        buttonElement.appendChild(spanSubmit);
        buttonElement.id = submitButtonId;
        buttonElement.style.backgroundColor = appearanceFields?.mainButtonColor;
        buttonElement.style.color = appearanceFields?.buttonTextColor;
        buttonElement.style.border = "none";
        const loaderElement = document.createElement("div");
        loaderElement.id = loaderElementId;
        loaderElement.className = "loader";
        // loaderElement.style.backgroundColor = 'red';
        // const imageElement = document.createElement("img");
        // imageElement.style.height = "20px"; // Change to your desired height
        // imageElement.style.width = "20px";

        // imageElement.setAttribute(
        //     "src",
        // "/thumbs-up.png"
        // );
        // // imageElement.src = "";
        // // loaderElement.textContent = "loading.."
        // loaderElement.appendChild(imageElement);
        buttonElement.appendChild(loaderElement);
        // loaderElement.style.display = 'none';
        footerDivElement.appendChild(buttonElement);
        if (footerFieldData?.attributes?.resetButton) {
          const resetButton = document.createElement("button");
          resetButton.type = "button";
          resetButton.id = "resetButton";
          resetButton.className = `${footerFieldData?.attributes?.buttonWidth
            ? "buttonWidth classicButton resetButton"
            : "classicButton resetButton"
            }`;
          resetButton.textContent =
            footerFieldData?.attributes?.resetButtonText;
          resetButton.style.color = appearanceFields?.buttonTextColor;
          footerDivElement.appendChild(resetButton);
        }
      }
      const reset = document.getElementById("resetButton");
      if (reset !== null) {
        reset.addEventListener("click", function () {
          const form = document.getElementById(formElementId);
          updateFormData(formElementId);
          form.reset();
          setDefaultValue();
        });
      }

      const bannerElement = document.createElement("div");
      bannerElement.id = bannerElementId;
      bannerElement.className = "polaris-banner";
      const bannerChildElement1 = document.createElement("div");
      bannerChildElement1.className = "Polaris-Banner__Dismiss";
      const bannerDismissButton = document.createElement("div");
      bannerDismissButton.className = "Polaris-Button";
      const bannerDismissSpanElement = document.createElement("span");
      bannerDismissButton.appendChild(bannerDismissSpanElement);
      const svgDismissNS = document.createElement("img");
      svgDismissNS.id = "close";
      svgDismissNS.setAttribute("width", "25");
      svgDismissNS.setAttribute("height", "25");
      svgDismissNS.setAttribute(
        "src",
        "https://img.icons8.com/sf-regular-filled/48/1A1A1A/x.png"
      );
      svgDismissNS.setAttribute("alt", "x");
      bannerDismissSpanElement.appendChild(svgDismissNS);
      bannerChildElement1.appendChild(bannerDismissButton);
      const bannerChildElement2 = document.createElement("div");
      bannerChildElement2.className = "Polaris-Banner__Ribbon";
      const ribbonElement = document.createElement("span");
      ribbonElement.className = "Polaris-Icon";
      const svgRightNS = document.createElement("img");
      svgRightNS.setAttribute("width", "25");
      svgRightNS.setAttribute("height", "25");
      svgRightNS.setAttribute("src", rightIcon);
      svgRightNS.setAttribute("alt", "k--v1");
      ribbonElement.appendChild(svgRightNS);
      bannerChildElement2.appendChild(ribbonElement);
      const bannerChildElement3 = document.createElement("div");
      bannerChildElement3.className = "Polaris-Banner__ContentWrapper";
      const bannerHeading = document.createElement("div");
      bannerHeading.className = "Polaris-Banner__Heading";
      const headingText = document.createElement("p");
      headingText.className = "Polaris-Heading";
      const headingTextDiv = document.createElement("div");
      headingTextDiv.className = "heading-text";
      headingTextDiv.textContent = afterSubmit.submitMessage;
      headingText.appendChild(headingTextDiv);
      bannerHeading.appendChild(headingText);
      bannerChildElement3.appendChild(bannerHeading);
      const bannerTextElement = document.createElement("div");
      bannerTextElement.className = "banner-main";
      bannerTextElement.appendChild(bannerChildElement2);
      bannerTextElement.appendChild(bannerChildElement3);
      bannerElement.appendChild(bannerTextElement);
      bannerElement.appendChild(bannerChildElement1);
      divElement.appendChild(bannerElement);
      bannerElement.style.display = "none";

      const close = document.getElementById("close");
      close.addEventListener("click", () =>
        handleClose(data?.elementData?._id)
      );
      // });
    }, 2000);
  }
};

function fetchData() {
  setTimeout(async () => {
    const mainElement = document.getElementsByClassName("form-builder-ips");
    const elementsArray = Array.from(mainElement);

    elementsArray.forEach(async (element) => {
      let formId = element.getAttribute("data-key");
      shopId = element.getAttribute("data-ap-key");
      try {
        const elementData = await getData(formId);
        const user = await getUser(shopId);
        const validationData = await getValidation(formId);
        const appearanceData = await getApperence(formId);
        const afterSubmit = await getAfterSubmit(formId);
        catchFormDivAndAppendForm({
          elementData,
          validationData,
          appearanceData,
          afterSubmit,
          element,
          user: user.userData,
        });
      } catch (error) {
        console.error("Error fetching data:", error);
      }
    });
  }, 2000);
}
fetchData();
